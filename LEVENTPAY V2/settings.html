
<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
<script src="assets/js/tg_shim.js?v=5"></script>
<script src="assets/js/tg_bridge.js?v=5"></script>
<script src="assets/js/tg_publish.js?v=5"></script>
<script src="assets/js/tg_unified.js?v=5"></script>

<script src="assets/js/admin-auth.js"></script>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>LEVANT Pay — لوحة الإعدادات</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">
<script>(function(){var w=console.warn;console.warn=function(){if(arguments[0]&&arguments[0].toString().indexOf("cdn.tailwindcss.com should not be used in production")>-1)return;return w&&w.apply(this,arguments);};})();</script><!-- TAILWIND_WARN_FILTER -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  *{font-family:'Cairo',sans-serif}
  body{background:#0f172a;color:#e5e7eb}
  .card{background:rgba(15,23,42,.6);backdrop-filter:blur(10px);border:1px solid rgba(148,163,184,.25)}
  input,select{color:#e5e7eb!important}
</style>
  <link rel="stylesheet" href="assets/css/anim_lite.css">
</head>
<body>
<main class="max-w-6xl mx-auto p-6">
  <header class="flex items-center justify-between">
    <h1 class="text-2xl font-extrabold">لوحة الإعدادات</h1>
    <a href="/" class="text-indigo-400 hover:text-indigo-300">← العودة</a>
  </header>

  <section class="card rounded-2xl p-5 mt-5">
    <h2 class="text-xl font-bold mb-3">الإعدادات العامة</h2>
    <form id="f" class="grid sm:grid-cols-2 gap-4 text-sm">
      <label>سعر الصرف (ل.س/$)
        <input name="fx" type="number" step="1" class="w-full mt-1 px-3 py-2 rounded-xl bg-slate-900 border border-slate-700">
      </label>
      <label>الحد الأدنى ($)
        <input name="min" type="number" step="1" class="w-full mt-1 px-3 py-2 rounded-xl bg-slate-900 border border-slate-700">
      </label>
      <label>% عمولة PayPal
        <input name="ppp" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-xl bg-slate-900 border border-slate-700">
      </label>
      <label>$ ثابت PayPal
        <input name="ppf" type="number" step="0.01" class="w-full mt-1 px-3 py-2 rounded-xl bg-slate-900 border border-slate-700">
      </label>
      </label>
      <label>PayPal Client ID (LIVE)
        <input name="ppcid" type="text" class="w-full mt-1 px-3 py-2 rounded-xl bg-slate-900 border border-slate-700" placeholder="Acd123...">
      </label>
      <label>% عمولة المنصّة
        <input name="site" type="number" step="0.1" class="w-full mt-1 px-3 py-2 rounded-xl bg-slate-900 border border-slate-700">
      </label>
      <div class="flex items-center gap-2 pt-6">
        <input id="syncFx" type="checkbox"><label for="syncFx" class="text-slate-300">تطبيق سعر الصرف على جميع المحافظات</label>
      </div>
      <div class="sm:col-span-2 flex gap-2 pt-2">
        <button class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500">حفظ</button>
        <button type="button" id="reset" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">إرجاع الافتراضيات</button>
        <span id="msg" class="ml-3 text-green-400 font-bold"></span>
      </div>
    </form>
  </section>

  <section class="card rounded-2xl p-5 mt-5">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-bold">أسعار المحافظات</h2>
      <div class="flex items-end gap-2">
        <select id="bulkMode" class="px-3 py-2 rounded-xl bg-slate-900 border border-slate-700">
          <option value="set_fx">ضبط = سعر الصرف</option>
          <option value="add">إضافة +Δ</option>
          <option value="mul">ضرب ×k</option>
        </select>
        <input id="bulkValue" type="number" step="1" class="px-3 py-2 rounded-xl bg-slate-900 border border-slate-700 w-32" placeholder="قيمة">
        <button id="applyBulk" type="button" class="px-3 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">تطبيق</button>
      </div>
    </div>
    <div id="ratesWrap" class="mt-3"></div>
  </section>

  <section class="card rounded-2xl p-5 mt-5">
    <h2 class="text-xl font-bold mb-3">لوحة الإحصائيات</h2>
    <div class="grid sm:grid-cols-4 gap-3 text-center">
      <div class="rounded-xl p-4 bg-slate-900/50 border border-slate-700"><div class="text-slate-400 text-sm">عدد التحويلات</div><div id="stCount" class="text-2xl font-extrabold mt-1">0</div></div>
      <div class="rounded-xl p-4 bg-slate-900/50 border border-slate-700"><div class="text-slate-400 text-sm">إجمالي USD</div><div id="stGross" class="text-2xl font-extrabold mt-1">0.00$</div></div>
      <div class="rounded-xl p-4 bg-slate-900/50 border border-slate-700"><div class="text-slate-400 text-sm">عمولة المنصّة (ربحنا)</div><div id="stSite" class="text-2xl font-extrabold mt-1">0.00$</div></div>
      <div class="rounded-xl p-4 bg-slate-900/50 border border-slate-700"><div class="text-slate-400 text-sm">صافي للعملاء</div><div id="stNet" class="text-2xl font-extrabold mt-1">0.00$</div></div>
    </div>
    <div class="mt-3">
      <button id="stReset" type="button" class="px-4 py-2 rounded-xl bg-rose-700 hover:bg-rose-600">تصفير الإحصائيات (محلي)</button>
    </div>
  </section>

  <section class="card rounded-2xl p-5 mt-5">
    <h2 class="text-xl font-bold mb-3">النشر السحابي (JSONBin) — بدون رفع ملفات</h2>
    <p class="text-slate-300 text-sm mb-3">Bin ID مضبوط مسبقًا: <b>68b6c589d0ea881f406f37e9</b>. فقط أدخل Master Key عند النشر.</p>
    <div class="grid sm:grid-cols-2 gap-3 text-sm">
      <label>Master Key (لن يُحفظ)
        <input id="binKey" type="password" placeholder="أدخل X-Master-Key" class="w-full mt-1 px-3 py-2 rounded-xl bg-slate-900 border border-slate-700">
      </label>
    </div>
    <div class="flex gap-2 mt-3">
      <button id="publishCloud" type="button" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">نشر الإعدادات الآن</button>
      <span id="cloudMsg" class="ml-3 text-green-400"></span>
    </div>
  </section>

</main>

<script src="assets/js/db-runtime.js"></script>
<script src="assets/js/admin-settings.js"></script>
<script src="assets/js/stats.js"></script>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  function fmt(x){ return Number(x||0).toFixed(2); }
  if (window.LevStats){
    const st = LevStats.get();
    document.getElementById('stCount').textContent = Number(st.count||0);
    document.getElementById('stGross').textContent = fmt(st.gross) + '$';
    document.getElementById('stSite').textContent  = fmt(st.siteFee) + '$';
    document.getElementById('stNet').textContent   = fmt(st.netUsd) + '$';
  }
  const rst=document.getElementById('stReset');
  if(rst){ rst.addEventListener('click',()=>{ if(confirm('أكيد بدك تصفّر الإحصائيات المحلية؟')){ LevStats.clear(); location.reload(); } }); }
});

document.getElementById('publishCloud').addEventListener('click', async ()=>{
  const key = (document.getElementById('binKey').value||'').trim();
  if(!key) return alert('أدخل Master Key');
  const body = {
    settings: DB.get('PX_SETTINGS', {}),
    rates: DB.get('PX_GOV_RATES', [])
  };
  try{
    const r = await fetch('https://api.jsonbin.io/v3/b/68b6c589d0ea881f406f37e9', {
      method:'PUT', headers:{ 'Content-Type':'application/json','X-Master-Key':key }, body: JSON.stringify(body)
    });
    if(!r.ok) throw new Error('HTTP '+r.status);
    document.getElementById('cloudMsg').textContent='تم النشر ✅';
    setTimeout(()=>document.getElementById('cloudMsg').textContent='',1500);
  }catch(e){ alert('فشل النشر: '+(e&&e.message||e)); }
});
</script>

<!-- === Telegram Settings (no token on client) === -->
<section class="card rounded-2xl p-5 my-6">
  <h2 class="text-lg font-bold mb-3">إعداد تيليجرام — آمن (بدون توكن في الواجهة)</h2>
  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm mb-1">Chat ID الافتراضي</label>
      <input id="chatIdInput" class="w-full bg-transparent border border-slate-600 rounded-xl p-3" placeholder="-100xxxxxxxx أو 123456789">
      <p class="text-xs text-slate-400 mt-1">يُخزَّن محليًا فقط (localStorage).</p>
    </div>
    <div>
      <label class="block text-sm mb-1">نص رسالة الاختبار</label>
      <input id="testTextInput" class="w-full bg-transparent border border-slate-600 rounded-xl p-3" value="اختبار من LEVENT Pay ✅">
    </div>
  </div>
  <div class="flex flex-wrap gap-2 mt-4">
    <button id="btnSaveChat" class="px-4 py-2 rounded-xl bg-blue-500 hover:bg-blue-600">حفظ Chat ID</button>
    <button id="btnSendTest" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600">إرسال تجربة</button>
    <button id="btnHealth" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-900 hover:bg-white">تحقق من الصحة</button>
    <button id="btnClear" class="px-4 py-2 rounded-xl bg-slate-100 text-slate-900 hover:bg-white">مسح التخزين</button>
  </div>
  <div id="tgStatus" class="text-xs mt-3 text-slate-300"></div>
  <p class="text-xs text-slate-400 mt-3">المسار الآمن: <code>/.netlify/functions/telegram-notify</code> — التوكن موجود فقط كـ Environment Variable في Netlify.</p>
</section>
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  function say(msg, ok){
    const el = $("tgStatus");
    if(!el) return;
    el.textContent = msg;
    el.style.color = ok ? "#22c55e" : "#ef4444";
  }
  function loadChat(){ try{ return (window.__LEV_TG_STORE__ && __LEV_TG_STORE__.loadChat()) || window.LEVENT_TG_CHAT_ID || ""; }catch(_){ return ""; } }
  function saveChat(v){ try{ if(window.__LEV_TG_STORE__) window.__LEV_TG_STORE__.saveChat((v||"").trim()); }catch(_){ } }

  document.addEventListener("DOMContentLoaded", () => {
    const chatInput = $("chatIdInput");
    const testText = $("testTextInput");
    if (chatInput) chatInput.value = loadChat();

    const btnSave = $("btnSaveChat");
    const btnSend = $("btnSendTest");
    const btnHealth = $("btnHealth");
    const btnClear = $("btnClear");

    if(btnSave){
      btnSave.onclick = function(){
        const v = (chatInput && chatInput.value || "").trim();
        if(!v) return say("الرجاء إدخال Chat ID", false);
        saveChat(v);
        say("تم الحفظ ✅", true);
      };
    }
    if(btnClear){
      btnClear.onclick = function(){
        try{ localStorage.removeItem("LEV_TG_CHAT_ID"); }catch(_){}
        if(chatInput) chatInput.value = "";
        say("تم مسح التخزين المحلي ✅", true);
      };
    }
    if(btnHealth){
      btnHealth.onclick = async function(){
        try{
          const r = await fetch('/.netlify/functions/health');
          const ct = (r.headers.get('content-type')||'').toLowerCase();
          const j = ct.includes('application/json') ? await r.json() : { ok:false, html: await r.text(), status: r.status };
          say("Health: " + (j.ok? JSON.stringify(j): ("status="+j.status+" | not JSON")), !!j.ok);
        }catch(e){
          say("Health failed: " + (e.message||e), false);
        }
      };
    }
    if(btnSend){
      btnSend.onclick = async function(){
        try{
          const chat = (chatInput && chatInput.value.trim()) || loadChat();
          if(!chat) return say("لا يوجد Chat ID — احفظه أولًا", false);
          const text = (testText && testText.value) || "اختبار ✅";
          const r = await fetch('/.netlify/functions/telegram-notify', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ chat_id: chat, text: text, parse_mode: 'HTML' })
          });
          const j = await r.json().catch(()=>({}));
          if(!r.ok || !j.ok) throw new Error(j.error || "فشل الإرسال");
          say("تم الإرسال ✔️ " + (j.result && j.result.message_id ? ("msg_id="+j.result.message_id) : ""), true);
        }catch(e){
          say("خطأ: " + (e.message||e), false);
        }
      };
    }
  });
})();
</script>
</body></html>
